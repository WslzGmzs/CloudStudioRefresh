# 🏗️ CloudStudio 监控管理系统架构文档

## 系统概览

CloudStudio 监控管理系统是一个基于 Deno 的单文件企业级监控平台，采用现代化的 Web 架构设计，提供完整的监控、管理和数据持久化功能。

## 🎯 设计目标

- **单文件部署**: 零依赖，一键部署到 Deno Deploy
- **企业级功能**: 完整的监控、认证、数据管理
- **高性能**: 异步处理，支持并发监控
- **易维护**: 模块化设计，清晰的代码结构
- **安全性**: 完整的认证和会话管理

## 🏛️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Web 浏览器客户端                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  登录页面   │  │  仪表板页面  │  │  系统日志   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP/HTTPS
┌─────────────────────┴───────────────────────────────────────┐
│                 Deno HTTP 服务器                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              路由处理层                                  │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │ │
│  │  │页面路由 │ │API路由  │ │认证路由 │ │系统路由 │      │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              业务逻辑层                                  │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │ │
│  │  │监控管理 │ │会话管理 │ │数据管理 │ │调度器   │      │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              数据访问层                                  │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │ │
│  │  │监控配置 │ │历史记录 │ │会话存储 │ │系统日志 │      │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                  Deno KV 数据库                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  监控数据   │  │  会话数据   │  │  系统数据   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技术栈

### 核心技术
- **运行时**: Deno 2.3.5+
- **语言**: TypeScript (严格模式)
- **数据库**: Deno KV (内置键值数据库)
- **HTTP 服务器**: Deno.serve (内置 HTTP 服务器)

### 前端技术
- **框架**: 原生 HTML/CSS/JavaScript
- **图表库**: Chart.js 4.4.0 (CDN)
- **样式**: 响应式 CSS，支持移动端
- **交互**: 原生 JavaScript，无框架依赖

### 部署平台
- **主要平台**: Deno Deploy
- **本地开发**: Deno CLI
- **容器化**: 支持 Docker (可选)

## 📊 数据模型

### 核心数据结构

#### 监控配置 (MonitorConfig)
```typescript
interface MonitorConfig {
  id: string;                    // 唯一标识符
  name: string;                  // 监控名称
  url: string;                   // 监控 URL
  method: 'GET' | 'POST' | 'HEAD'; // HTTP 方法
  interval: number;              // 监控间隔（分钟）
  enabled: boolean;              // 是否启用
  cookie?: string;               // 可选 Cookie
  headers?: Record<string, string>; // 自定义请求头
  timeout: number;               // 超时时间（毫秒）
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
}
```

#### 监控历史 (MonitorHistory)
```typescript
interface MonitorHistory {
  id: string;                    // 历史记录 ID
  monitorId: string;             // 关联的监控配置 ID
  timestamp: Date;               // 执行时间
  success: boolean;              // 是否成功
  responseTime: number;          // 响应时间（毫秒）
  statusCode?: number;           // HTTP 状态码
  error?: string;                // 错误信息
  responseSize?: number;         // 响应大小（字节）
}
```

#### 会话管理 (Session)
```typescript
interface Session {
  id: string;                    // 会话 ID
  authenticated: boolean;        // 认证状态
  expires: Date;                 // 过期时间
  createdAt: Date;               // 创建时间
  lastAccess: Date;              // 最后访问时间
}
```

### 数据存储结构

#### Deno KV 键空间设计
```
monitors/{id}                  // 监控配置
sessions/{sessionId}           // 会话数据
history/{monitorId}/{id}       // 监控历史
system_logs/{timestamp}/{id}   // 系统日志
login_attempts/{ip}/{id}       // 登录尝试记录
settings/{key}                 // 系统设置
```

## 🔄 核心流程

### 监控执行流程
```
1. 调度器启动 → 2. 获取启用的监控配置 → 3. 并发执行监控任务
                                                    ↓
8. 更新下次执行时间 ← 7. 记录系统日志 ← 6. 保存监控历史 ← 5. 处理响应结果
                                                    ↑
                                            4. 发送 HTTP 请求
```

### 用户认证流程
```
1. 用户访问 → 2. 检查会话 → 3. 未认证跳转登录 → 4. 验证密码
                   ↓                              ↓
            5. 已认证进入仪表板 ← 6. 创建会话 ← 7. 认证成功
```

### 数据持久化流程
```
1. 业务操作 → 2. 数据验证 → 3. KV 存储 → 4. 返回结果
                   ↓              ↓
            5. 错误处理 ← 6. 存储失败
```

## 🛡️ 安全设计

### 认证机制
- **密码认证**: 硬编码密码或环境变量配置
- **会话管理**: 基于 Cookie 的会话系统
- **自动过期**: 可配置的会话过期时间
- **登录限制**: 防暴力破解的频率限制

### 数据安全
- **输入验证**: 严格的数据验证和清理
- **SQL 注入防护**: 使用 KV 存储避免 SQL 注入
- **XSS 防护**: 输出转义和内容安全策略
- **CSRF 防护**: 会话验证和安全头设置

### 网络安全
- **HTTPS 支持**: 生产环境强制 HTTPS
- **安全头**: 完整的 HTTP 安全响应头
- **CORS 控制**: 严格的跨域资源共享控制

## ⚡ 性能优化

### 并发处理
- **异步监控**: 所有监控任务并发执行
- **非阻塞 I/O**: 使用 Deno 的异步 API
- **连接池**: HTTP 请求复用连接
- **超时控制**: 防止长时间阻塞

### 内存管理
- **数据清理**: 定期清理过期数据
- **分页查询**: 大数据集分页处理
- **缓存策略**: 合理的数据缓存机制
- **垃圾回收**: 及时释放不需要的资源

### 存储优化
- **索引设计**: 优化的 KV 键结构
- **批量操作**: 减少数据库访问次数
- **数据压缩**: 适当的数据压缩策略
- **定期维护**: 自动化的数据维护任务

## 🔌 扩展性设计

### 模块化架构
- **松耦合**: 各模块独立，易于扩展
- **接口抽象**: 清晰的模块接口定义
- **插件机制**: 支持功能插件扩展
- **配置驱动**: 通过配置控制功能开关

### 水平扩展
- **无状态设计**: 支持多实例部署
- **数据分片**: KV 存储天然支持分布式
- **负载均衡**: 支持负载均衡器
- **服务发现**: 支持服务注册与发现

## 📈 监控和运维

### 系统监控
- **健康检查**: 内置健康检查端点
- **性能指标**: 响应时间、成功率等指标
- **错误追踪**: 完整的错误日志记录
- **资源监控**: 内存、CPU 使用情况

### 运维支持
- **日志管理**: 结构化日志输出
- **配置管理**: 环境变量配置
- **部署自动化**: 一键部署脚本
- **故障恢复**: 自动重启和恢复机制

## 🚀 部署架构

### Deno Deploy 部署
```
GitHub Repository → Deno Deploy → Global Edge Network
       ↓                ↓              ↓
   代码推送        自动构建        全球分发
```

### 本地开发环境
```
开发机器 → Deno CLI → 本地 KV 存储 → 浏览器测试
```

### 生产环境建议
```
CDN → Load Balancer → Deno Deploy Instances → Deno KV Cluster
```

这个架构设计确保了系统的高可用性、高性能和易维护性，同时保持了单文件部署的简洁性。
