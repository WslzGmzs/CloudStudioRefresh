# CloudStudio 监控系统架构文档

## 系统概述

CloudStudio 监控系统是一个基于 Deno 的网站监控解决方案，采用前后端分离的模块化架构设计，集成了前端界面、后端 API、数据存储和任务调度等功能。

## 🎯 设计目标

- **高性能**: 通过内存缓存和智能查询优化，减少90% KV读取量
- **可扩展**: 模块化架构，易于添加新功能和维护
- **易部署**: 符合Deno Deploy限制，支持一键部署
- **用户友好**: 现代化响应式界面，良好的用户体验

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                      │
├─────────────────────────────────────────────────────────────┤
│  public/index.html  │  public/css/  │  public/js/           │
│  主页面             │  样式文件      │  JavaScript逻辑        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        API层 (API Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  api/auth.ts    │  api/monitors.ts  │  api/stats.ts        │
│  认证API        │  监控配置API      │  统计数据API          │
│                 │  api/system.ts    │                      │
│                 │  系统管理API      │                      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      服务层 (Service Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  services/cache.ts     │  services/monitor.ts              │
│  内存缓存服务          │  监控执行服务                      │
│  services/scheduler.ts │  services/kv.ts                   │
│  任务调度服务          │  数据库服务                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                      │
├─────────────────────────────────────────────────────────────┤
│                        Deno KV 数据库                         │
│  monitors/  │  sessions/  │  history/  │  system_logs/      │
│  监控配置   │  用户会话   │  历史记录  │  系统日志           │
└─────────────────────────────────────────────────────────────┘
```

## 📁 目录结构

```
project/
├── server.ts                 # 🚀 主服务器入口文件
├── deno.json                 # ⚙️ Deno配置文件
├── config/                   # 📋 配置文件
│   ├── app.ts                # 应用配置
│   └── constants.ts          # 常量定义
├── models/                   # 📊 数据模型
│   ├── monitor.ts            # 监控相关接口
│   ├── auth.ts               # 认证相关接口
│   └── system.ts             # 系统相关接口
├── services/                 # 🔧 业务逻辑服务
│   ├── cache.ts              # 内存缓存服务
│   ├── monitor.ts            # 监控执行服务
│   ├── scheduler.ts          # 任务调度服务
│   └── kv.ts                 # KV数据库服务
├── api/                      # 🌐 API路由处理
│   ├── auth.ts               # 认证API
│   ├── monitors.ts           # 监控配置API
│   ├── stats.ts              # 统计数据API
│   └── system.ts             # 系统API
├── utils/                    # 🛠️ 工具函数
│   ├── response.ts           # 响应工具
│   └── helpers.ts            # 通用工具
└── public/                   # 🎨 前端文件
    ├── index.html            # 主页面
    ├── css/styles.css        # 样式文件
    ├── js/app.js             # 主应用逻辑
    ├── js/api.js             # API调用
    └── assets/               # 静态资源
```

## 🔄 数据流

### 1. 用户请求流程

```
用户浏览器 → 静态文件服务 → HTML/CSS/JS
           ↓
用户操作 → JavaScript → API请求 → 后端处理 → 数据库操作 → 响应返回
```

### 2. 监控任务流程

```
定时调度器 → 获取监控配置 → 检查执行间隔 → 执行监控任务 → 保存结果 → 更新状态
```

### 3. 缓存机制

```
API请求 → 检查缓存 → 缓存命中？ → 返回缓存数据
                   ↓ (未命中)
                数据库查询 → 保存到缓存 → 返回数据
```

## ⚡ 性能优化

### 1. 内存缓存系统

- **缓存策略**: LRU + TTL
- **缓存层级**: 
  - 监控配置缓存 (2分钟TTL)
  - 历史记录缓存 (5分钟TTL)
  - 系统日志缓存 (3分钟TTL)

### 2. 查询优化

- **分页查询**: 限制单次查询数量
- **索引优化**: 基于时间戳的查询优化
- **批量处理**: 监控任务批量执行

### 3. 前端优化

- **自动刷新优化**: 30秒→2分钟
- **手动刷新控制**: 用户主动控制数据更新
- **响应式设计**: 移动端适配

## 🔐 安全设计

### 1. 认证机制

- **会话管理**: 基于Cookie的会话认证
- **密码保护**: 环境变量配置管理员密码
- **会话过期**: 可配置的会话过期时间

### 2. 数据安全

- **输入验证**: 严格的参数验证
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输出转义和CSP头

### 3. 访问控制

- **API认证**: 所有API都需要认证
- **权限检查**: 统一的权限验证机制

## 📊 监控机制

### 1. 系统监控

- **健康检查**: `/api/system/health`
- **性能指标**: 响应时间、成功率
- **资源使用**: 缓存使用情况

### 2. 业务监控

- **监控状态**: 实时监控任务状态
- **历史统计**: 24小时/7天数据统计
- **告警机制**: 异常状态检测

## 🚀 部署架构

### Deno Deploy 部署

```
GitHub Repository → Deno Deploy → 全球CDN → 用户访问
                                    ↓
                              Deno KV 数据库
```

### 部署优势

- **无服务器**: 自动扩缩容
- **全球分发**: 边缘计算节点
- **高可用**: 99.9%可用性保证
- **成本优化**: 按使用量计费

## 🔧 扩展性设计

### 1. 水平扩展

- **无状态设计**: 服务层无状态
- **缓存分离**: 可扩展到分布式缓存
- **数据库分片**: 支持数据分片

### 2. 功能扩展

- **插件机制**: 模块化插件系统
- **API扩展**: RESTful API设计
- **前端组件**: 可复用的UI组件

### 3. 集成扩展

- **Webhook支持**: 事件通知机制
- **第三方集成**: 告警系统集成
- **数据导出**: 多格式数据导出

## 📈 未来规划

### 短期目标

- [ ] 完善日志查看功能
- [ ] 添加邮件告警
- [ ] 增强数据可视化

### 长期目标

- [ ] 多租户支持
- [ ] 分布式监控
- [ ] AI智能分析
